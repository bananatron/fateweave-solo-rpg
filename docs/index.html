<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fateweave - Solo RPG</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.6;
            padding: 24px;
            background: #f9f9f9;
            color: #333;
            font-size: 14px;
        }
        
        h1, h2, h3 {
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        h1 { font-size: 24px; }
        h2 { font-size: 18px; }
        h3 { font-size: 16px; }
        
        p { margin-bottom: 16px; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .game-layout {
            display: flex;
            gap: 24px;
            margin-top: 24px;

            @media only screen and (max-width: 1085px) {
                flex-wrap: wrap;
            }
        }
        
        .panel {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 24px;
            flex-grow: 1;
            flex-basis: 45%;
        }
        
        button {
            font-family: 'JetBrains Mono', monospace;
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
            padding: 8px 16px;
            margin: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #e8e8e8;
        }
        
        .dice-result {
            font-size: 18px;
            font-weight: 700;
            margin: 24px 0;
            padding: 16px;
            border: 1px solid #d0d0d0;
            background: #f8f8f8;
        }
        
        #dungeonMap {
            border: 2px solid #333;
            background: white;
            width: 100%;
        }
        
        .character-stat {
            margin: 12px 0;
            padding: 8px;
            background: #f8f8f8;
        }
        
        .scar {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin: 0 4px;
            border: 2px solid #333;
            border-radius: 50%;
        }
        
        .scar.filled {
            background: #333;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 24px;
        }
        
        .tab {
            display: inline-block;
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid #d0d0d0;
            border-bottom: none;
            margin-right: 4px;
            background: #f8f8f8;
        }
        
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            position: relative;
            top: 1px;
        }
        
        .tab-content {
            display: none;
            padding: 16px;
            border: 1px solid #d0d0d0;
            background: white;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .story-entry {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .clock-segment {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 1px solid #333;
            margin: 0 2px;
        }
        
        .clock-segment.filled {
            background: #333;
        }
        
        input[type="text"], textarea {
            font-family: 'JetBrains Mono', monospace;
            padding: 8px;
            margin: 8px 0;
            width: 100%;
            border: 1px solid #d0d0d0;
            font-size: 14px;
        }
        
        #startScreen {
            text-align: center;
            max-width: 600px;
            margin: 40px auto;
            border: 1px solid #d0d0d0;
            padding: 32px;
            background: white;
        }
        
        .hidden {
            display: none;
        }
        
        .radio-group {
            margin: 24px 0;
            text-align: left;
        }
        
        .radio-option {
            margin: 12px 0;
        }
        
        .talent-description {
            font-size: 13px;
            color: #666;
            margin-left: 24px;
        }
        
        .talent-reminder {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        
        .story-actions {
            margin-top: 16px;
        }
        
        .delete-btn {
            font-size: 12px;
            padding: 2px 6px;
            cursor: pointer;
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
        }
        
        .small-btn {
            font-size: 12px;
            padding: 2px 6px;
        }
        
        #journalButton {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 8px 16px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 24px;
            width: 80%;
            max-width: 600px;
            border: 1px solid #d0d0d0;
        }
        
        .close {
            position: absolute;
            right: 16px;
            top: 8px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .journal-entry {
            border: 1px solid #d0d0d0;
            padding: 12px;
            margin: 12px 0;
            background: #f8f8f8;
            position: relative;
        }
        
        .journal-entry .delete-btn {
            position: absolute;
            right: 8px;
            top: 8px;
        }
        
        .generated-content {
            border: 1px solid #d0d0d0;
            padding: 16px;
            margin: 16px 0;
            background: #f8f8f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Fateweave RPG</h1>
        
        <div id="startScreen">
            <h2>Create Your Character</h2>
            
            <div style="margin: 20px 0;">
                <input type="text" id="characterName" placeholder="Character Name">
                <button onclick="generateName()">Random Name</button>
            </div>
            
            <div class="radio-group">
                <h3>Choose Archetype:</h3>
                <div class="radio-option">
                    <input type="radio" id="warrior" name="archetype" value="Warrior">
                    <label for="warrior">Warrior - Strong, brave, skilled with weapons</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="mage" name="archetype" value="Mage">
                    <label for="mage">Mage - Wise, magical, understands ancient secrets</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="rogue" name="archetype" value="Rogue">
                    <label for="rogue">Rogue - Quick, clever, good at sneaking and tricks</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="custom" name="archetype" value="custom">
                    <label for="custom">Custom - Create your own archetype</label>
                </div>
                <div id="customArchetypeInput" style="display: none; margin-left: 25px; margin-top: 10px;">
                    <input type="text" id="customArchetype" placeholder="Enter archetype name">
                    <input type="text" id="customArchetypeDesc" placeholder="What are they good at?" style="width: 300px; margin-top: 5px;">
                </div>
            </div>
            
            <div class="radio-group">
                <h3>Choose Talent:</h3>
                <div class="radio-option">
                    <input type="radio" id="secondWind" name="talent" value="secondWind">
                    <label for="secondWind">Second Wind</label>
                    <div class="talent-description">Once per scene, avoid defeat</div>
                </div>
                <div class="radio-option">
                    <input type="radio" id="luckyBreak" name="talent" value="luckyBreak">
                    <label for="luckyBreak">Lucky Break</label>
                    <div class="talent-description">Reroll one die per scene</div>
                </div>
                <div class="radio-option">
                    <input type="radio" id="keenEye" name="talent" value="keenEye">
                    <label for="keenEye">Keen Eye</label>
                    <div class="talent-description">Ask one extra question when exploring</div>
                </div>
                <div class="radio-option">
                    <input type="radio" id="ironWill" name="talent" value="ironWill">
                    <label for="ironWill">Iron Will</label>
                    <div class="talent-description">Resist one magical effect per scene</div>
                </div>
            </div>
            
            <button onclick="startGame()">Begin Adventure</button>
            <p style="margin-top: 20px; color: #666;">Or <a href="#" onclick="loadSavedGame(); return false;">Continue Saved Game</a></p>
        </div>

        <div id="gameScreen" class="hidden">
            <div class="game-layout">
                <!-- Left Panel - Character & Story -->
                <div class="panel">
                    <h2>Character</h2>
                    <div class="character-sheet">
                        <div class="character-stat">
                            <strong>Name:</strong> <span id="charName"></span>
                        </div>
                        <div class="character-stat">
                            <strong>Archetype:</strong> <span id="charArchetype"></span>
                        </div>
                        <div class="character-stat">
                            <strong>Talent:</strong> <span id="charTalent"></span>
                            <div class="talent-reminder" id="talentReminder"></div>
                        </div>
                        <div class="character-stat">
                            <strong>Goal:</strong> <span id="charGoal"></span>
                        </div>
                        <div class="character-stat">
                            <strong>Scars:</strong>
                            <button class="small-btn" onclick="removeScar()">-</button>
                            <span id="scars">
                                <span class="scar"></span>
                                <span class="scar"></span>
                                <span class="scar"></span>
                            </span>
                            <button class="small-btn" onclick="addScar()">+</button>
                        </div>
                    </div>

                    <h3>Story Clock</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="small-btn" onclick="decrementClock()">-</button>
                        <span id="storyClock">
                            <span class="clock-segment"></span>
                            <span class="clock-segment"></span>
                            <span class="clock-segment"></span>
                            <span class="clock-segment"></span>
                            <span class="clock-segment"></span>
                            <span class="clock-segment"></span>
                        </span>
                        <button class="small-btn" onclick="incrementClock()">+</button>
                    </div>

                    <h3>Story Log</h3>
                    <div id="storyLog" style="max-height: 300px; overflow-y: auto;">
                    </div>
                    <div class="story-actions">
                        <button onclick="clearStoryLog()">Clear Log</button>
                        <button onclick="undoLastEntry()">Undo Last</button>
                    </div>
                </div>

                <!-- Center Panel - All Tabs -->
                <div class="panel">
                    <div class="tabs">
                        <span class="tab active" onclick="switchTab('map')">Map</span>
                        <span class="tab" onclick="switchTab('actions')">Actions</span>
                        <span class="tab" onclick="switchTab('oracle')">Oracle</span>
                        <span class="tab" onclick="switchTab('details')">Details</span>
                        <span class="tab" onclick="switchTab('npc')">NPCs</span>
                        <span class="tab" onclick="switchTab('monsters')">Monsters</span>
                        <span class="tab" onclick="switchTab('factions')">Factions</span>
                        <span class="tab" onclick="switchTab('quests')">Quests</span>
                        <span class="tab" onclick="switchTab('journal')">Journal</span>
                    </div>

                    <div id="mapTab" class="tab-content active">
                        <h2>Dungeon Map</h2>
                        <canvas id="dungeonMap" width="600" height="400"></canvas>
                        <div style="margin-top: 10px;">
                            <button onclick="dropRoom()">New Room</button>
                            <button onclick="exploreRoom()">Explore Current Room</button>
                            <button onclick="removeLastRoom()">Remove Last Room</button>
                        </div>
                    </div>

                    <div id="actionsTab" class="tab-content">
                        <h2>Actions</h2>
                        <div style="margin-bottom: 20px;">
                            <button onclick="rollFateDice()">Roll Fate Dice</button>
                            <button onclick="combatRoll()">Combat Roll</button>
                        </div>
                        <div id="diceResult" class="dice-result"></div>
                        <div id="actionResult" style="margin-top: 20px;"></div>
                    </div>

                    <div id="oracleTab" class="tab-content">
                        <h2>Oracle</h2>
                        <input type="text" id="oracleQuestion" placeholder="Ask a yes/no question">
                        <button onclick="askOracle()">Ask Oracle</button>
                        <div id="oracleResult" style="margin-top: 20px;"></div>
                    </div>

                    <div id="detailsTab" class="tab-content">
                        <h2>Details Generator</h2>
                        <p>Generate atmospheric details for ambiguous questions like "What's in the room?" or "What are they wearing?"</p>
                        <button onclick="generateDetail()">Generate Detail</button>
                        <div id="detailResult" style="margin-top: 20px;"></div>
                    </div>

                    <div id="npcTab" class="tab-content">
                        <h2>NPC Generator</h2>
                        <button onclick="generateNPC()">Generate NPC</button>
                        <div id="npcResult"></div>
                    </div>

                    <div id="monstersTab" class="tab-content">
                        <h2>Monster Generator</h2>
                        <button onclick="generateMonster()">Generate Monster</button>
                        <div id="monsterResult"></div>
                    </div>

                    <div id="factionsTab" class="tab-content">
                        <h2>Factions</h2>
                        <button onclick="generateFaction()">Generate Faction</button>
                        <div id="factionResult"></div>
                    </div>

                    <div id="questsTab" class="tab-content">
                        <h2>Quest Generator</h2>
                        <button onclick="generateQuest()">Generate Quest</button>
                        <div id="questResult"></div>
                    </div>

                    <div id="journalTab" class="tab-content">
                        <h2>Journal</h2>
                        <button onclick="openJournalModal()">Add Note</button>
                        <div id="journalEntries" style="margin-top: 20px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Modal -->
    <div id="journalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeJournalModal()">&times;</span>
            <h2>Add Journal Note</h2>
            <textarea id="journalNote" style="width: 100%; height: 100px; margin: 10px 0;" placeholder="Write your note here..."></textarea>
            <button onclick="saveJournalNote()">Save Note</button>
        </div>
    </div>

    <!-- Journal Button -->
    <button id="journalButton" onclick="openJournalModal()">Journal</button>

    <script>
        // Game Data
        let gameData = {
            character: {
                name: '',
                archetype: '',
                talent: '',
                goal: '',
                scars: 0,
                position: { x: 300, y: 200 }
            },
            dungeon: {
                rooms: [],
                currentRoom: null
            },
            story: {
                clockSegments: 0,
                log: []
            },
            journal: []
        };

        // Tables
        const tables = {
            names: {
                first: ['Aldric', 'Brynn', 'Caelum', 'Dara', 'Eirik', 'Fiona', 'Gareth', 'Hilda', 'Ivar', 'Jora', 
                       'Kael', 'Lyra', 'Magnus', 'Nora', 'Oswin', 'Petra', 'Quinn', 'Rhea', 'Soren', 'Thora'],
                last: ['Ironheart', 'Stormwind', 'Brightblade', 'Shadowmere', 'Goldleaf', 'Fireborn', 'Frostbeard', 
                      'Swiftarrow', 'Strongarm', 'Wiseheart', 'Silvertongue', 'Blackwood', 'Redmane', 'Whitestone']
            },
            goals: [
                'Find the lost artifact of their ancestors',
                'Avenge their fallen family',
                'Discover the truth about their mysterious past',
                'Save their village from an ancient curse',
                'Prove themselves worthy to their order',
                'Find a cure for a deadly plague',
                'Recover stolen sacred relics',
                'Map the unknown territories',
                'Break free from a magical bond',
                'Unite the warring clans',
                'Uncover a conspiracy against the crown',
                'Master forbidden magic',
                'Find their missing sibling',
                'Restore honor to their name',
                'Prevent an ancient prophecy'
            ],
            monsterTypes: ['Beast', 'Humanoid', 'Undead', 'Elemental', 'Aberration', 'Dragon-kin'],
            monsterTraits: ['Armored', 'Swift', 'Magical', 'Numerous', 'Cunning', 'Terrifying'],
            monsterQuirks: ['Collect shiny objects', 'Speak in riddles', 'Afraid of specific thing', 
                           'Serve a master', 'Guard something', 'Seek something'],
            roomTypes: ['Empty', 'Monster', 'Treasure', 'Trap', 'Hidden Door'],
            factions: [
                { name: 'The Iron Crown', goal: 'Expand their tyrannical rule', method: 'Military conquest', resource: 'Vast armies', enemy: 'The Wandering Folk' },
                { name: 'The Wandering Folk', goal: 'Preserve freedom of movement', method: 'Trade and diplomacy', resource: 'Information network', enemy: 'The Iron Crown' },
                { name: 'The Cult of Whispers', goal: 'Unlock forbidden magic', method: 'Secret rituals', resource: 'Ancient knowledge', enemy: 'The Star Watchers' },
                { name: 'The Beast Lords', goal: 'Return nature to dominance', method: 'Shapeshifting infiltration', resource: 'Control over beasts', enemy: 'The Tomb Seekers' },
                { name: 'The Tomb Seekers', goal: 'Plunder ancient treasures', method: 'Archaeological expeditions', resource: 'Magical artifacts', enemy: 'The Beast Lords' },
                { name: 'The Star Watchers', goal: 'Prevent prophesied doom', method: 'Celestial observation', resource: 'Prophetic visions', enemy: 'The Cult of Whispers' }
            ],
            questTypes: ['Rescue', 'Retrieve', 'Explore', 'Defeat', 'Discover', 'Escort'],
            oracleResults: [
                { range: [2, 3], text: 'No, and...' },
                { range: [4, 5], text: 'No' },
                { range: [6, 8], text: 'Yes, but...' },
                { range: [9, 10], text: 'Yes' },
                { range: [11, 12], text: 'Yes, and...' }
            ],
            npc: {
                occupations: ['Blacksmith', 'Merchant', 'Guard', 'Farmer', 'Scholar', 'Priest', 'Hunter', 'Thief', 'Noble', 
                              'Minstrel', 'Healer', 'Sailor', 'Innkeeper', 'Alchemist', 'Scribe', 'Mercenary', 'Beggar', 
                              'Messenger', 'Craftsman', 'Fisher', 'Mage Apprentice', 'Soldier', 'Baker', 'Gambler'],
                traits: ['Honest', 'Greedy', 'Suspicious', 'Friendly', 'Nervous', 'Proud', 'Secretive', 'Helpful', 
                        'Aggressive', 'Curious', 'Tired', 'Cheerful', 'Paranoid', 'Ambitious', 'Lazy', 'Brave', 
                        'Cowardly', 'Wise', 'Foolish', 'Patient', 'Impatient', 'Loyal', 'Deceptive', 'Generous'],
                appearances: ['Tall', 'Short', 'Scarred', 'Well-dressed', 'Ragged', 'Muscular', 'Thin', 'Elderly', 
                             'Young', 'Bearded', 'Clean-shaven', 'Tattooed', 'One-eyed', 'Limping', 'Hooded', 
                             'Armored', 'Cloaked', 'Dirty', 'Perfumed', 'Pale', 'Tanned', 'Hairy', 'Bald'],
                wants: ['Money', 'Information', 'Protection', 'Revenge', 'Love', 'Power', 'Escape', 'Food', 
                       'Medicine', 'Justice', 'Recognition', 'Forgiveness', 'A favor', 'To hide', 'To find someone', 
                       'To warn you', 'To sell something', 'To buy something', 'Help', 'To make a deal'],
                secrets: ['Is being followed', 'Knows about treasure', 'Is actually nobility', 'Committed a crime', 
                         'Has magical abilities', 'Works for the enemy', 'Is dying', 'Owes money', 'Is in love', 
                         'Knows your past', 'Is a spy', 'Has a cursed item', 'Killed someone', 'Is searching for family', 
                         'Betrayed someone', 'Has a hidden identity', 'Knows a prophecy', 'Is being blackmailed']
            },
            details: {
                senses: ['Ancient', 'Bloody', 'Burning', 'Damp', 'Dusty', 'Echoing', 'Foggy', 'Glowing', 'Humming', 'Icy', 
                        'Musty', 'Oily', 'Putrid', 'Rustling', 'Shadowy', 'Silent', 'Smoky', 'Sparkling', 'Whispering', 'Windy'],
                elements: ['Bones', 'Chains', 'Crystals', 'Feathers', 'Flowers', 'Gears', 'Glass', 'Leaves', 'Metal', 'Moss', 
                          'Mushrooms', 'Paper', 'Roots', 'Runes', 'Sand', 'Silk', 'Stone', 'Thorns', 'Water', 'Wood'],
                conditions: ['Abandoned', 'Broken', 'Ceremonial', 'Concealed', 'Corrupted', 'Cursed', 'Decorated', 'Forgotten', 
                            'Fresh', 'Hidden', 'Locked', 'Magical', 'Moving', 'New', 'Old', 'Overgrown', 'Preserved', 'Rotting', 
                            'Sacred', 'Valuable'],
                purposes: ['Battle', 'Celebration', 'Communication', 'Containment', 'Craft', 'Defense', 'Execution', 'Healing', 
                          'Knowledge', 'Navigation', 'Offering', 'Prison', 'Protection', 'Punishment', 'Rest', 'Ritual', 
                          'Storage', 'Trade', 'Travel', 'Worship'],
                emotions: ['Afraid', 'Angry', 'Anxious', 'Calm', 'Confused', 'Curious', 'Desperate', 'Determined', 'Excited', 
                          'Greedy', 'Happy', 'Hopeful', 'Lonely', 'Proud', 'Sad', 'Secretive', 'Suspicious', 'Tired', 
                          'Vengeful', 'Worried'],
                actions: ['Arguing', 'Building', 'Celebrating', 'Destroying', 'Fleeing', 'Guarding', 'Hiding', 'Hunting', 
                         'Investigating', 'Learning', 'Negotiating', 'Performing', 'Planning', 'Praying', 'Preparing', 
                         'Repairing', 'Resting', 'Searching', 'Stealing', 'Trading']
            }
        };

        const talentNames = {
            'secondWind': 'Second Wind',
            'luckyBreak': 'Lucky Break',
            'keenEye': 'Keen Eye',
            'ironWill': 'Iron Will'
        };

        const talentDescriptions = {
            'secondWind': 'Once per scene, avoid defeat',
            'luckyBreak': 'Reroll one die per scene',
            'keenEye': 'Ask one extra question when exploring',
            'ironWill': 'Resist one magical effect per scene'
        };

        // Canvas setup
        let canvas, ctx;

        function initCanvas() {
            canvas = document.getElementById('dungeonMap');
            ctx = canvas.getContext('2d');
            
            // Clear and redraw
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#ddd';
            for (let x = 0; x < canvas.width; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 20) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            // Redraw all rooms
            gameData.dungeon.rooms.forEach(room => {
                drawRoom(room);
            });

            // Add starting room if no rooms exist
            if (gameData.dungeon.rooms.length === 0) {
                addRoom(300, 200, 'Start');
            }
        }

        function addRoom(x, y, type) {
            const room = {
                x: x - 20,
                y: y - 20,
                width: 40,
                height: 40,
                type: type,
                explored: false
            };
            
            gameData.dungeon.rooms.push(room);
            gameData.dungeon.currentRoom = room;
            drawRoom(room);
            saveGame();
        }

        function drawRoom(room) {
            ctx.fillStyle = room === gameData.dungeon.currentRoom ? '#ddf' : '#fff';
            ctx.fillRect(room.x, room.y, room.width, room.height);
            ctx.strokeStyle = room === gameData.dungeon.currentRoom ? '#00f' : '#000';
            ctx.strokeRect(room.x, room.y, room.width, room.height);
            
            ctx.fillStyle = '#000';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(room.type, room.x + room.width/2, room.y + room.height/2);
        }

        function dropRoom() {
            // Simulate dropping pencil
            const currentRoom = gameData.dungeon.currentRoom;
            const angle = Math.random() * Math.PI * 2;
            const distance = (Math.random() * 4 + 1) * 40; // 1-5 squares away
            
            const newX = currentRoom.x + currentRoom.width/2 + Math.cos(angle) * distance;
            const newY = currentRoom.y + currentRoom.height/2 + Math.sin(angle) * distance;
            
            // Determine room type
            const roomType = tables.roomTypes[Math.floor(Math.random() * tables.roomTypes.length)];
            
            // Draw corridor
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(currentRoom.x + currentRoom.width/2, currentRoom.y + currentRoom.height/2);
            ctx.lineTo(newX, newY);
            ctx.stroke();
            ctx.lineWidth = 1;
            
            addRoom(newX, newY, roomType);
            addStoryEntry(`You discover a new room: ${roomType}`);
        }

        function removeLastRoom() {
            if (gameData.dungeon.rooms.length > 1) {
                gameData.dungeon.rooms.pop();
                gameData.dungeon.currentRoom = gameData.dungeon.rooms[gameData.dungeon.rooms.length - 1];
                initCanvas();
                saveGame();
            }
        }

        function rollDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function rollFateDice() {
            const die1 = rollDice(6);
            const die2 = rollDice(6);
            const total = die1 + die2;
            
            let result;
            if (die1 === 6 || die2 === 6) {
                result = "Great Success!";
            } else if (total >= 8) {
                result = "Success with complication";
            } else if (total >= 4) {
                result = "Failure with opportunity";
            } else {
                result = "Disaster!";
            }
            
            const diceResult = document.getElementById('diceResult');
            diceResult.textContent = `${die1} + ${die2} = ${total} - ${result}`;
            
            return { die1, die2, total, result };
        }

        function combatRoll() {
            const roll = rollFateDice();
            const actionResult = document.getElementById('actionResult');
            
            if (roll.die1 === 6 || roll.die2 === 6) {
                actionResult.innerHTML = "Enemy defeated instantly!";
            } else if (roll.total >= 8) {
                actionResult.innerHTML = "Trade blows - enemy wounded, you take a Scar";
                addScar();
            } else if (roll.total >= 4) {
                actionResult.innerHTML = "You take a Scar but may retreat";
                addScar();
            } else {
                actionResult.innerHTML = "Take 2 Scars or be captured!";
                addScar();
                addScar();
            }
        }

        function addScar() {
            if (gameData.character.scars < 3) {
                gameData.character.scars++;
                updateScars();
                saveGame();
                
                if (gameData.character.scars === 3) {
                    addStoryEntry("Your character has fallen! Game Over.");
                    alert("Your character has fallen! Create a new character to continue.");
                }
            }
        }

        function removeScar() {
            if (gameData.character.scars > 0) {
                gameData.character.scars--;
                updateScars();
                saveGame();
            }
        }

        function updateScars() {
            const scarElements = document.querySelectorAll('.scar');
            scarElements.forEach((scar, index) => {
                if (index < gameData.character.scars) {
                    scar.classList.add('filled');
                } else {
                    scar.classList.remove('filled');
                }
            });
        }

        function incrementClock() {
            if (gameData.story.clockSegments < 6) {
                gameData.story.clockSegments++;
                updateStoryClock();
                saveGame();
                
                if (gameData.story.clockSegments === 6) {
                    triggerMajorEvent();
                }
            }
        }

        function decrementClock() {
            if (gameData.story.clockSegments > 0) {
                gameData.story.clockSegments--;
                updateStoryClock();
                saveGame();
            }
        }

        function updateStoryClock() {
            const segments = document.querySelectorAll('.clock-segment');
            segments.forEach((segment, index) => {
                if (index < gameData.story.clockSegments) {
                    segment.classList.add('filled');
                } else {
                    segment.classList.remove('filled');
                }
            });
        }

        function triggerMajorEvent() {
            const events = [
                "A faction makes a major move!",
                "A new threat emerges from the shadows!",
                "An ally calls for urgent help!",
                "A long-hidden secret is revealed!",
                "Disaster strikes the region!",
                "The final confrontation approaches!"
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            addStoryEntry(`MAJOR EVENT: ${event}`);
            gameData.story.clockSegments = 0;
            updateStoryClock();
            saveGame();
        }

        function generateMonster() {
            const type = tables.monsterTypes[Math.floor(Math.random() * tables.monsterTypes.length)];
            const trait = tables.monsterTraits[Math.floor(Math.random() * tables.monsterTraits.length)];
            const quirk = tables.monsterQuirks[Math.floor(Math.random() * tables.monsterQuirks.length)];
            
            const monsterResult = document.getElementById('monsterResult');
            monsterResult.innerHTML = `
                <div class="generated-content">
                    <h3>${type}</h3>
                    <p><strong>Trait:</strong> ${trait}</p>
                    <p><strong>Quirk:</strong> ${quirk}</p>
                </div>
            `;
            
            addStoryEntry(`Encountered: ${trait} ${type} that ${quirk.toLowerCase()}`);
        }

        function generateFaction() {
            const faction = tables.factions[Math.floor(Math.random() * tables.factions.length)];
            
            const factionResult = document.getElementById('factionResult');
            factionResult.innerHTML = `
                <div class="generated-content">
                    <h3>${faction.name}</h3>
                    <p><strong>Goal:</strong> ${faction.goal}</p>
                    <p><strong>Method:</strong> ${faction.method}</p>
                    <p><strong>Resource:</strong> ${faction.resource}</p>
                    <p><strong>Enemy:</strong> ${faction.enemy}</p>
                </div>
            `;
        }

        function generateQuest() {
            const questType = tables.questTypes[Math.floor(Math.random() * tables.questTypes.length)];
            const faction = tables.factions[Math.floor(Math.random() * tables.factions.length)];
            
            const questResult = document.getElementById('questResult');
            questResult.innerHTML = `
                <div class="generated-content">
                    <h3>${questType} Quest</h3>
                    <p>Related to: ${faction.name}</p>
                    <p>${generateQuestDescription(questType, faction)}</p>
                </div>
            `;
        }

        function generateQuestDescription(type, faction) {
            const descriptions = {
                'Rescue': `Save someone captured by ${faction.name}`,
                'Retrieve': `Find an artifact important to ${faction.name}`,
                'Explore': `Map a region controlled by ${faction.name}`,
                'Defeat': `Stop a plan of ${faction.name}`,
                'Discover': `Learn the truth about ${faction.name}`,
                'Escort': `Protect someone from ${faction.name}`
            };
            return descriptions[type];
        }

        function askOracle() {
            const question = document.getElementById('oracleQuestion').value;
            if (!question) return;
            
            const roll = rollDice(6) + rollDice(6);
            const result = tables.oracleResults.find(r => roll >= r.range[0] && roll <= r.range[1]);
            
            const oracleResult = document.getElementById('oracleResult');
            oracleResult.innerHTML = `
                <p><strong>Question:</strong> ${question}</p>
                <p><strong>Answer:</strong> ${result.text}</p>
            `;
            
            addStoryEntry(`Oracle: "${question}" - ${result.text}`);
        }

        function addStoryEntry(text, index = null) {
            if (index !== null) {
                gameData.story.log.splice(index, 0, text);
            } else {
                gameData.story.log.push(text);
            }
            updateStoryLog();
            saveGame();
        }

        function removeStoryEntry(index) {
            gameData.story.log.splice(index, 1);
            updateStoryLog();
            saveGame();
        }

        function updateStoryLog() {
            const storyLog = document.getElementById('storyLog');
            storyLog.innerHTML = '';
            
            gameData.story.log.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'story-entry';
                div.innerHTML = `
                    <span>${entry}</span>
                    <button class="delete-btn" onclick="removeStoryEntry(${index})">×</button>
                `;
                storyLog.appendChild(div);
            });
            
            storyLog.scrollTop = storyLog.scrollHeight;
        }

        function clearStoryLog() {
            if (confirm('Clear all story entries?')) {
                gameData.story.log = [];
                updateStoryLog();
                saveGame();
            }
        }

        function undoLastEntry() {
            if (gameData.story.log.length > 0) {
                gameData.story.log.pop();
                updateStoryLog();
                saveGame();
            }
        }

        function exploreRoom() {
            const currentRoom = gameData.dungeon.currentRoom;
            if (!currentRoom.explored) {
                currentRoom.explored = true;
                
                switch (currentRoom.type) {
                    case 'Monster':
                        generateMonster();
                        break;
                    case 'Treasure':
                        addStoryEntry("You find valuable treasure!");
                        break;
                    case 'Trap':
                        addStoryEntry("A trap! Roll Fate Dice to avoid it.");
                        break;
                    case 'Hidden Door':
                        addStoryEntry("You discover a hidden door. Where does it lead?");
                        break;
                    default:
                        addStoryEntry("The room is empty and safe to rest.");
                }
                saveGame();
            } else {
                addStoryEntry("You've already explored this room.");
            }
        }

        function generateName() {
            const firstName = tables.names.first[Math.floor(Math.random() * tables.names.first.length)];
            const lastName = tables.names.last[Math.floor(Math.random() * tables.names.last.length)];
            document.getElementById('characterName').value = `${firstName} ${lastName}`;
        }

        function generateGoal() {
            return tables.goals[Math.floor(Math.random() * tables.goals.length)];
        }

        function startGame() {
            const name = document.getElementById('characterName').value;
            const archetypeRadio = document.querySelector('input[name="archetype"]:checked');
            const talentRadio = document.querySelector('input[name="talent"]:checked');
            
            if (!name) {
                alert('Please enter a character name!');
                return;
            }
            
            if (!archetypeRadio) {
                alert('Please choose an archetype!');
                return;
            }
            
            if (!talentRadio) {
                alert('Please choose a talent!');
                return;
            }
            
            let archetype = archetypeRadio.value;
            let archetypeDesc = '';
            
            if (archetype === 'custom') {
                archetype = document.getElementById('customArchetype').value;
                archetypeDesc = document.getElementById('customArchetypeDesc').value;
                
                if (!archetype) {
                    alert('Please enter a custom archetype name!');
                    return;
                }
                if (!archetypeDesc) {
                    alert('Please describe what your archetype is good at!');
                    return;
                }
            }
            
            const talent = talentRadio.value;
            const goal = generateGoal();
            
            gameData.character = {
                name,
                archetype,
                archetypeDesc,
                talent,
                goal,
                scars: 0,
                position: { x: 300, y: 200 }
            };
            
            document.getElementById('charName').textContent = name;
            document.getElementById('charArchetype').textContent = archetype;
            document.getElementById('charTalent').textContent = talentNames[talent];
            document.getElementById('talentReminder').textContent = `(${talentDescriptions[talent]})`;
            document.getElementById('charGoal').textContent = goal;
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            initCanvas();
            addStoryEntry(`${name} the ${archetype} begins their quest: ${goal}`);
            saveGame();
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Save and Load functions
        function saveGame() {
            localStorage.setItem('fateweaverQuest', JSON.stringify(gameData));
        }

        function loadGame() {
            const savedData = localStorage.getItem('fateweaverQuest');
            if (savedData) {
                gameData = JSON.parse(savedData);
                updateUI();
                initCanvas();
            }
        }

        function loadSavedGame() {
            const savedData = localStorage.getItem('fateweaverQuest');
            if (savedData) {
                gameData = JSON.parse(savedData);
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                updateUI();
                initCanvas();
            } else {
                alert('No saved game found!');
            }
        }

        function updateUI() {
            // Update character info
            document.getElementById('charName').textContent = gameData.character.name;
            document.getElementById('charArchetype').textContent = gameData.character.archetype;
            document.getElementById('charTalent').textContent = talentNames[gameData.character.talent];
            document.getElementById('talentReminder').textContent = `(${talentDescriptions[gameData.character.talent]})`;
            document.getElementById('charGoal').textContent = gameData.character.goal;
            
            // Update scars
            updateScars();
            
            // Update story clock
            updateStoryClock();
            
            // Update story log
            updateStoryLog();
            
            // Update journal
            updateJournalDisplay();
        }

        function generateDetail() {
            const sense = tables.details.senses[Math.floor(Math.random() * tables.details.senses.length)];
            const element = tables.details.elements[Math.floor(Math.random() * tables.details.elements.length)];
            const condition = tables.details.conditions[Math.floor(Math.random() * tables.details.conditions.length)];
            const purpose = tables.details.purposes[Math.floor(Math.random() * tables.details.purposes.length)];
            const emotion = tables.details.emotions[Math.floor(Math.random() * tables.details.emotions.length)];
            const action = tables.details.actions[Math.floor(Math.random() * tables.details.actions.length)];
            
            const detailResult = document.getElementById('detailResult');
            detailResult.innerHTML = `
                <div class="generated-content">
                    <h3>Atmospheric Details</h3>
                    <p><strong>Sense/Atmosphere:</strong> ${sense}</p>
                    <p><strong>Physical Element:</strong> ${element}</p>
                    <p><strong>Condition:</strong> ${condition}</p>
                    <p><strong>Purpose/Function:</strong> ${purpose}</p>
                    <p><strong>Emotional Vibe:</strong> ${emotion}</p>
                    <p><strong>Current Activity:</strong> ${action}</p>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #f5f5f5;">
                    <em>Interpret these elements together to answer questions about what's in the room, what someone is wearing, what they're thinking, or what's happening in the scene.</em>
                </div>
            `;
            
            addStoryEntry(`Detail Check: ${sense} ${element} (${condition}) for ${purpose} - feeling ${emotion}, currently ${action}`);
        }
        
        function generateNPC() {
            const firstName = tables.names.first[Math.floor(Math.random() * tables.names.first.length)];
            const occupation = tables.npc.occupations[Math.floor(Math.random() * tables.npc.occupations.length)];
            const trait = tables.npc.traits[Math.floor(Math.random() * tables.npc.traits.length)];
            const appearance = tables.npc.appearances[Math.floor(Math.random() * tables.npc.appearances.length)];
            const want = tables.npc.wants[Math.floor(Math.random() * tables.npc.wants.length)];
            const secret = tables.npc.secrets[Math.floor(Math.random() * tables.npc.secrets.length)];
            
            const npcResult = document.getElementById('npcResult');
            npcResult.innerHTML = `
                <div class="generated-content">
                    <h3>${firstName} the ${occupation}</h3>
                    <p><strong>Appearance:</strong> ${appearance}</p>
                    <p><strong>Personality:</strong> ${trait}</p>
                    <p><strong>Wants:</strong> ${want}</p>
                    <p><strong>Secret:</strong> ${secret}</p>
                </div>
            `;
            
            addStoryEntry(`Met ${firstName} the ${occupation} - ${appearance}, ${trait}, wants ${want.toLowerCase()}`);
        }

        // Journal functions
        function openJournalModal() {
            document.getElementById('journalModal').style.display = 'block';
        }
        
        function closeJournalModal() {
            document.getElementById('journalModal').style.display = 'none';
            document.getElementById('journalNote').value = '';
        }
        
        function saveJournalNote() {
            const note = document.getElementById('journalNote').value;
            if (note.trim()) {
                const timestamp = new Date().toLocaleString();
                const journalEntry = { timestamp, note };
                
                if (!gameData.journal) gameData.journal = [];
                gameData.journal.push(journalEntry);
                
                addStoryEntry(`[Journal] ${note}`);
                updateJournalDisplay();
                closeJournalModal();
                saveGame();
            }
        }
        
        function updateJournalDisplay() {
            const journalEntries = document.getElementById('journalEntries');
            if (!journalEntries) return;
            
            journalEntries.innerHTML = '';
            
            if (gameData.journal && gameData.journal.length > 0) {
                gameData.journal.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'journal-entry';
                    div.innerHTML = `
                        <div><strong>${entry.timestamp}</strong></div>
                        <div>${entry.note}</div>
                        <button class="delete-btn" onclick="removeJournalEntry(${index})">×</button>
                    `;
                    journalEntries.appendChild(div);
                });
            } else {
                journalEntries.innerHTML = '<p>No journal entries yet.</p>';
            }
        }
        
        function removeJournalEntry(index) {
            gameData.journal.splice(index, 1);
            updateJournalDisplay();
            saveGame();
        }

        // Initialize when page loads
        window.onload = function() {
            // Generate a name for the character
            generateName(); 

            // Use MutationObserver instead of deprecated DOMSubtreeModified
            const diceResultElement = document.getElementById('diceResult');
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const text = diceResultElement.textContent;
                        if (text.includes('Failure') || text.includes('Disaster')) {
                            incrementClock();
                        }
                    }
                });
            });
            
            observer.observe(diceResultElement, {
                childList: true,
                characterData: true,
                subtree: true
            });
            
            // Add event listener for archetype radio buttons
            const archetypeRadios = document.querySelectorAll('input[name="archetype"]');
            archetypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const customInput = document.getElementById('customArchetypeInput');
                    if (this.value === 'custom') {
                        customInput.style.display = 'block';
                    } else {
                        customInput.style.display = 'none';
                    }
                });
            });
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('journalModal');
                if (event.target == modal) {
                    closeJournalModal();
                }
            };
        };
    </script>
</body>
</html>
